const state={lang:localStorage.getItem('lang')||'en',theme:localStorage.getItem('theme')||(window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'),hazard:'all',district:'',severity:'all',sort:'newest',page:1,pageSize:8,data:null};const $=e=>document.querySelector(e);function setTheme(e){state.theme=e,document.documentElement.classList.toggle('light','light'===e),localStorage.setItem('theme',e)}function initLang(){$('#langToggle').addEventListener('click',()=>{state.lang='en'===state.lang?'hi':'en',localStorage.setItem('lang',state.lang),render()})}function initShare(){const e=$('#shareBtn');navigator.share?e.addEventListener('click',async()=>{try{await navigator.share({title:document.title,text:'Disaster Portal',url:location.href})}catch{}}):e.addEventListener('click',()=>{navigator.clipboard.writeText(location.href),e.querySelector('span').textContent='Copied!',setTimeout(()=>e.querySelector('span').textContent='Share',1200)})}async function loadData(){const e=await fetch('data/content.json');state.data=await e.json(),$('#reportForm').href=state.data.settings.report_form_url||'#',$('#year').textContent=(new Date).getFullYear(),render()}function filterAlerts(e){return e.filter(e=>'all'===state.hazard||e.hazard===state.hazard).filter(e=>'all'===state.severity||e.severity===state.severity).filter(e=>!state.district||e.district.toLowerCase().includes(state.district.toLowerCase()))}function sortAlerts(e){const t={advisory:0,yellow:1,orange:2,red:3};return'newest'===state.sort?e.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)):'oldest'===state.sort?e.sort((e,t)=>new Date(e.timestamp)-new Date(t.timestamp)):'severity'===state.sort?e.sort((e,s)=>t[s.severity]-t[e.severity]||new Date(s.timestamp)-new Date(e.timestamp)):e}function paginate(e){const t=(state.page-1)*state.pageSize;return e.slice(t,t+state.pageSize)}function renderAlerts(){const e=$('#alerts');e.innerHTML='';const t=filterAlerts(state.data.alerts.slice()),s=t.length,a=sortAlerts(t),n=paginate(a);if(0===n.length)e.innerHTML='<p class="muted">No alerts match your filters.</p>';else for(const t of n){const s=document.createElement('article');s.className='card';const a=t.title[state.lang]||t.title.en,n=t.body[state.lang]||t.body.en;s.innerHTML=`<div class="meta"><span class="badge ${t.hazard}">${t.hazard}</span> • <span class="badge">${t.severity}</span> • ${t.district}</div><h3>${a}</h3><p>${n}</p><div class="meta">${new Date(t.timestamp).toLocaleString()}</div>`,e.appendChild(s)}e.setAttribute('aria-busy','false');const r=Math.max(1,Math.ceil(s/state.pageSize));$('#prevPage').disabled=state.page<=1,$('#nextPage').disabled=state.page>=r,$('#pageInfo').textContent=`Page ${state.page} of ${r}`,$('#status').textContent=`Last updated: ${(new Date).toLocaleString()} • ${s} alert(s)`}function renderGuides(){const e=$('#guides');e.innerHTML='';for(const t of state.data.guides){const s=t.title[state.lang]||t.title.en,a=t.summary[state.lang]||t.summary.en,n=document.createElement('article');n.className='card',n.innerHTML=`<div class="meta"><span class="badge ${t.hazard}">${t.hazard}</span> • ${t.level}</div><h3>${s}</h3><p>${a}</p><a class="btn" href="${t.url}" target="_blank" rel="noopener">Open</a>`,e.appendChild(n)}}function renderContacts(){const e=$('#contacts');e.innerHTML='';for(const t of state.data.contacts){const s=document.createElement('li');s.textContent=`${t.name}: ${t.phone}${t.notes?' — '+t.notes:''}`,e.appendChild(s)}}function renderShelters(){const e=$('#shelters');e.innerHTML='';for(const t of state.data.shelters){const s=document.createElement('li');s.textContent=`${t.name} — ${t.address}${t.capacity?' (Cap: '+t.capacity+')':''}`,e.appendChild(s)}}function renderPress(){const e=$('#press');e.innerHTML='';for(const t of state.data.press){const s=document.createElement('li');s.innerHTML=`<a href="${t.url}" target="_blank" rel="noopener">${t.title}</a> <span class="muted">(${t.date})</span>`,e.appendChild(s)}}function render(){renderAlerts(),renderGuides(),renderContacts(),renderShelters(),renderPress()}function initUI(){$('#hazard').addEventListener('change',e=>{state.hazard=e.target.value,state.page=1,render()}),$('#district').addEventListener('input',e=>{state.district=e.target.value,state.page=1,render()}),$('#severity').addEventListener('change',e=>{state.severity=e.target.value,state.page=1,render()}),$('#sort').addEventListener('change',e=>{state.sort=e.target.value,render()}),$('#clear').addEventListener('click',()=>{state.hazard='all',state.district='',state.severity='all',state.sort='newest',state.page=1,$('#hazard').value='all',$('#district').value='',$('#severity').value='all',$('#sort').value='newest',render()}),$('#themeToggle').addEventListener('click',()=>setTheme('light'===state.theme?'dark':'light')),$('#prevPage').addEventListener('click',()=>{state.page=Math.max(1,state.page-1),render()}),$('#nextPage').addEventListener('click',()=>{state.page=state.page+1,render()})}function registerSW(){'serviceWorker'in navigator&&navigator.serviceWorker.register('sw.js')}document.addEventListener('DOMContentLoaded',()=>{setTheme(state.theme),initLang(),initShare(),initUI(),registerSW(),loadData()});
<script>
async function loadTicker(){
  try {
    const res = await fetch("https://api.reliefweb.int/v1/reports?appname=hazardhub&profile=list&preset=latest&limit=10");
    const data = await res.json();
    const items = data.data.map(item => ({
      title: item.fields.title,
      url: item.fields.url,
      image: item.fields?.primary_image?.url || item.fields?.thumbnail?.url || null
    }));
    const track = document.getElementById('newsTrack');
    track.innerHTML = '';
    const cards = items.map(n => {
      const a = document.createElement('a');
      a.href = n.url; a.target = '_blank'; a.rel = 'noopener';
      a.className = 'ticker-card';
      a.innerHTML = `${n.image ? `<img src="${n.image}" alt="">` : ''}<span>${n.title}</span>`;
      return a;
    });
    [...cards, ...cards].forEach(el => track.appendChild(el)); // repeat for smooth scroll
  } catch (e) {
    console.error("Failed to load news", e);
  }
}
document.addEventListener('DOMContentLoaded', loadTicker);
</script>