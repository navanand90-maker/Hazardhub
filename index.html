<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HazardHub</title>
<style>
:root { --g1:#0f172a; --g2:#0b3b5a; --g3:#0b5a4a; --fg:#f1f5f9; }
* { box-sizing: border-box; }
body {
  margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  color:var(--fg);
  min-height:100vh;
  background: linear-gradient(120deg, var(--g1), var(--g2), var(--g3));
  background-size:200% 200%;
  animation: gradientShift 20s ease infinite;
}
@keyframes gradientShift { 0%{background-position:0% 0%} 50%{background-position:100% 50%} 100%{background-position:0% 0%} }
.container { max-width:1100px; margin: 0 auto; padding: 24px; }
h1 { margin:0 0 8px; font-weight:700; letter-spacing:.2px; }
.muted { opacity:.85; margin: 0 0 24px; }

.card {
  background: rgba(15,23,42,.55);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,.2);
}

.grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); }

.ticker {
  overflow:hidden; white-space:nowrap;
  border-top:1px solid rgba(255,255,255,.1);
  border-bottom:1px solid rgba(255,255,255,.1);
  background: rgba(255,255,255,.06); backdrop-filter: blur(6px);
  margin: 12px 0 24px;
}
.ticker-track { display:inline-block; padding:.6rem 0; animation: scroll-left 40s linear infinite; }
.ticker-item { display:inline-block; margin-right:2rem; }
.ticker-item a { color: var(--fg); text-decoration: none; }
@keyframes scroll-left { 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }

ul { list-style:none; padding:0; margin: 8px 0 0; }
li { margin: 8px 0; }
a { color:#c8e8ff; }
small { opacity:.8; }

.footer { opacity:.7; font-size:12px; margin-top:24px; text-align:center; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>HazardHub</h1>
      <p class="muted">Live disaster news, weather, alerts & research â€” auto-updated every 2 hours.</p>
    </header>

    <!-- Scrolling News Ticker -->
    <section class="ticker card">
      <div id="ticker-track" class="ticker-track">Loading latest headlinesâ€¦</div>
    </section>

    <!-- Weather -->
    <section id="weather" class="card">
      <h3>Local Weather</h3>
      <p>Detecting your locationâ€¦</p>
    </section>

    <!-- Alerts + Research -->
    <section class="grid" style="margin-top:16px;">
      <div class="card">
        <h3>Regional & Global Alerts</h3>
        <ul id="alerts-list"><li>Loadingâ€¦</li></ul>
      </div>
      <div class="card">
        <h3>Recent Research</h3>
        <ul id="research-list"><li>Loadingâ€¦</li></ul>
      </div>
    </section>

    <p class="footer">Made for hazardhub.net â€¢ Data sources: GDACS, ReliefWeb, Open-Meteo, Nature & others.</p>
  </div>

<script>
function prettyTemp(t){ return Math.round(t) + "Â°C"; }

async function loadTicker() {
  try {
    const res = await fetch('/api/news');
    const items = await res.json();
    const track = document.getElementById('ticker-track');
    const slice = items.slice(0, 20);
    const html = slice.map(n => `
      <span class="ticker-item">ðŸ“° <a href="${n.link}" target="_blank" rel="noopener">${n.title}</a> <small>(${n.source ?? ''})</small></span>
    `).join('');
    track.innerHTML = html + html; // duplicate for seamless loop
  } catch (e) {
    console.error(e);
    document.getElementById('ticker-track').textContent = "Unable to load headlines.";
  }
}

async function loadList(endpoint, ulId, limit=10) {
  try {
    const res = await fetch(endpoint);
    const items = await res.json();
    const ul = document.getElementById(ulId);
    ul.innerHTML = items.slice(0, limit).map(i =>
      `<li><a href="${i.link}" target="_blank" rel="noopener">${i.title}</a> <small>${i.source ?? ''}</small></li>`
    ).join('');
  } catch (e) {
    console.error(e);
    document.getElementById(ulId).innerHTML = "<li>Failed to load.</li>";
  }
}

async function loadWeather(lat, lon) {
  try {
    const res = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
    const data = await res.json();
    const todayMax = data?.daily?.temperature_2m_max?.[0];
    const todayMin = data?.daily?.temperature_2m_min?.[0];
    const precip = data?.daily?.precipitation_sum?.[0];
    document.getElementById('weather').innerHTML = `
      <h3>Local Weather</h3>
      <p><strong>Today:</strong> ${prettyTemp(todayMin)}â€“${prettyTemp(todayMax)} â€¢ ðŸŒ§ ${precip ?? 0} mm</p>
    `;
  } catch (e) {
    console.error(e);
    document.getElementById('weather').innerHTML = "<p>Unable to fetch local weather.</p>";
  }
}

function fallbackIP() {
  document.getElementById('weather').innerHTML = "<h3>Local Weather</h3><p>Enable location to see local weather.</p>";
}

function init() {
  loadTicker();
  loadList('/api/alerts', 'alerts-list', 10);
  loadList('/api/research', 'research-list', 10);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => loadWeather(pos.coords.latitude, pos.coords.longitude),
      _err => fallbackIP(),
      { timeout: 8000 }
    );
  } else {
    fallbackIP();
  }
}
init();
</script>
</body>
</html>